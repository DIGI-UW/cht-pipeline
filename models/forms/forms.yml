version: 1

models:
  - name: data_record
    config:
      contract:
        enforced: true
    columns:
      - name: uuid
        data_type: string
        constraints:
          - type: foreign_key
            expression: "{{ env_var('POSTGRES_SCHEMA') }}.document_metadata (uuid) ON DELETE CASCADE"
          - type: unique
        data_tests:
          - not_null
          - relationships:
              to: ref('document_metadata')
              field: uuid
      - name: saved_timestamp
        data_type: timestamp
      - name: reported
        data_type: timestamp with time zone
      - name: form
        data_type: string
      - name: from_phone
        data_type: string
      - name: patient_id
        data_type: string
      - name: place_id
        data_type: string
      - name: contact_uuid
        data_type: string
      - name: parent_uuid
        data_type: string
      - name: grandparent_uuid
        data_type: string
  - name: monitoring_messages
    config:
      tags: ["monitoring"]
      contract:
        enforced: true
    columns:
      - name: uuid
        data_type: string
        constraints:
          - type: foreign_key
            expression: "{{ env_var('POSTGRES_SCHEMA') }}.document_metadata (uuid) ON DELETE CASCADE"
          - type: unique
        data_tests:
          - not_null
          - relationships:
              to: ref('document_metadata')
              field: uuid
      - name: saved_timestamp
        data_type: timestamp
        data_tests:
          - not_null
      - name: reported
        data_type: timestamp with time zone
        data_tests:
          - not_null
      - name: from_phone
        data_type: string
        data_tests:
          - not_null
      - name: expected_time_slot
        data_type: string
        data_tests:
          - accepted_values:
              values: ['morning', 'afternoon', 'evening', 'other']
        description: "Time slot when message was sent (morning: 6-8am, afternoon: 12-2pm, evening: 6-8pm)"
      - name: is_expected_monitoring_time
        data_type: boolean
        description: "True if message was sent during expected monitoring hours (6-8am, 12-2pm, 6-8pm)"
      - name: message_content
        data_type: string
        description: "SMS message content extracted from multiple possible JSON paths"
      - name: message_date
        data_type: date
        data_tests:
          - not_null
      - name: message_hour
        data_type: double precision
        description: "Hour of day when message was sent (0-23)"
      - name: day_of_week
        data_type: double precision
        description: "Day of week when message was sent (0=Sunday, 6=Saturday)"
      - name: time_since_last_message
        data_type: interval
        description: "Time elapsed since the last message from this phone number"
      - name: message_health
        data_type: string
        data_tests:
          - not_null
          - accepted_values:
              values: ['healthy', 'gap_detected', 'processing_error', 'deleted']
        description: "Health status based on gaps and errors"
